(function(){'use strict';if(typeof fetch==='undefined'){window.fetch=(u,o)=>new Promise((r,j)=>{let x=new XMLHttpRequest();x.open((o&&o.method)||'GET',u);x.onload=()=>r({json:()=>Promise.resolve(JSON.parse(x.responseText))});x.onerror=j;x.send((o&&o.body)||null);});}var CONFIG={tmdbApiKey:'1ad1fd4b4938e876aa6c96d0cded9395',cacheTime:43200000,enabled:true,language:'uk'};var style=document.createElement('style');style.textContent=`.card--season-complete,.card--season-progress{position:absolute;left:0;margin-left:-0.65em;bottom:0.50em;z-index:12;width:fit-content;max-width:calc(100% - 1em);border-radius:0.3em;overflow:hidden;opacity:0;transition:opacity .22s ease-in-out}.card--season-complete{background-color:rgba(61,161,141,.9)}.card--season-progress{background-color:rgba(255,66,66,1)}.card--season-complete div,.card--season-progress div{text-transform:uppercase;font-family:'Roboto Condensed','Arial Narrow',Arial,sans-serif;font-weight:700;font-size:1em;padding:.39em .39em;white-space:nowrap;display:flex;align-items:center;gap:4px;text-shadow:.5px .5px 1px rgba(0,0,0,.3);color:#fff}.card--season-complete.show,.card--season-progress.show{opacity:1}@media(max-width:768px){.card--season-complete div,.card--season-progress div{font-size:.95em;padding:.35em .4em}}`;document.head.appendChild(style);function getMediaType(d){if(!d)return'unknown';if(d.name||d.first_air_date)return'tv';if(d.title||d.release_date)return'movie';return'unknown'}var cache={};try{cache=JSON.parse(localStorage.getItem('seasonBadgeCache')||'{}')}catch(e){cache={}}function fetchSeriesData(id){return new Promise((res,rej)=>{if(cache[id]&&(Date.now()-cache[id].timestamp<CONFIG.cacheTime))return res(cache[id].data);if(!CONFIG.tmdbApiKey)return rej(new Error('Немає API ключа'));let u=`https://api.themoviedb.org/3/tv/${id}?api_key=${CONFIG.tmdbApiKey}&language=${CONFIG.language}`;fetch(u).then(r=>r.json()).then(d=>{if(d.success===false)throw new Error(d.status_message);cache[id]={data:d,timestamp:Date.now()};try{localStorage.setItem('seasonBadgeCache',JSON.stringify(cache))}catch(e){}res(d)}).catch(rej)})}function getSeasonProgress(d){if(!d||!d.seasons||!d.last_episode_to_air)return!1;var l=d.last_episode_to_air,s=d.seasons.find(x=>x.season_number===l.season_number&&x.season_number>0);if(!s)return!1;var t=s.episode_count||0,a=l.episode_number||0;return{seasonNumber:l.season_number,airedEpisodes:a,totalEpisodes:t,isComplete:a>=t}}function createBadge(c,is,l){var b=document.createElement('div');b.className=(is?'card--season-complete':'card--season-progress')+(l?' loading':'');b.innerHTML=`<div>${c}</div>`;return b}function adjustBadgePosition(c,b){let q=c.querySelector('.card__quality');if(q&&b){let h=q.offsetHeight,v=parseFloat(getComputedStyle(q).bottom)||0;b.style.bottom=(h+v)+'px'}else if(b)b.style.bottom='0.50em'}function updateBadgePositions(c){c.querySelectorAll('.card--season-complete,.card--season-progress').forEach(b=>adjustBadgePosition(c,b))}var qualityObserver=new MutationObserver(m=>{m.forEach(mu=>{mu.addedNodes&&mu.addedNodes.forEach(n=>{if(n.classList&&n.classList.contains('card__quality')){var c=n.closest('.card');if(c)setTimeout(()=>updateBadgePositions(c),100)}});mu.removedNodes&&mu.removedNodes.forEach(n=>{if(n.classList&&n.classList.contains('card__quality')){var c=n.closest('.card');if(c)setTimeout(()=>updateBadgePositions(c),100)}})})});function addSeasonBadge(c){if(!c||c.hasAttribute('data-season-processed'))return;if(!c.card_data){requestAnimationFrame(()=>addSeasonBadge(c));return}var d=c.card_data;if(getMediaType(d)!=='tv')return;var v=c.querySelector('.card__view');if(!v)return;v.querySelectorAll('.card--season-complete,.card--season-progress').forEach(b=>b.remove());var b=createBadge('...',!1,!0);v.appendChild(b);adjustBadgePosition(c,b);try{qualityObserver.observe(v,{childList:!0,subtree:!0})}catch(e){}c.setAttribute('data-season-processed','loading');fetchSeriesData(d.id).then(tm=>{var p=getSeasonProgress(tm);if(p){var cont='',is=p.isComplete;if(is)cont=`S${p.seasonNumber}`;else cont=`S${p.seasonNumber} ${p.airedEpisodes}/${p.totalEpisodes}`;b.className=is?'card--season-complete':'card--season-progress';b.innerHTML=`<div>${cont}</div>`;adjustBadgePosition(c,b);setTimeout(()=>{b.classList.add('show');adjustBadgePosition(c,b)},50);c.setAttribute('data-season-processed',is?'complete':'in-progress')}else{b.remove();c.setAttribute('data-season-processed','error')}}).catch(e=>{console.log('SeasonBadgePlugin помилка:',e.message);b.remove();c.setAttribute('data-season-processed','error')})}var observer=new MutationObserver(m=>{m.forEach(mu=>{mu.addedNodes&&mu.addedNodes.forEach(n=>{if(n.nodeType!==1)return;if(n.classList&&n.classList.contains('card'))addSeasonBadge(n);if(n.querySelectorAll)n.querySelectorAll('.card').forEach(addSeasonBadge)})})});window.addEventListener('resize',()=>{document.querySelectorAll('.card--season-complete,.card--season-progress').forEach(b=>{var c=b.closest('.card');if(c)adjustBadgePosition(c,b)})});function initPlugin(){if(!CONFIG.enabled)return;var cont=document.querySelectorAll('.cards,.card-list,.content,.main,.cards-list,.preview__list');if(cont.length>0){cont.forEach(co=>{try{observer.observe(co,{childList:!0,subtree:!0})}catch(e){console.log('Помилка спостереження:',e)}})}else observer.observe(document.body,{childList:!0,subtree:!0});document.querySelectorAll('.card:not([data-season-processed])').forEach((c,i)=>{setTimeout(()=>addSeasonBadge(c),i*300)})}if(window.appready)initPlugin();else if(window.Lampa&&Lampa.Listener)Lampa.Listener.follow('app',e=>{if(e.type==='ready')initPlugin()});else setTimeout(initPlugin,2000);})();
  
